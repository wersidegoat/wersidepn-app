<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>WersidePN</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
            padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
            transition: background 0.3s, color 0.3s;
        }

        /* Темная тема (по умолчанию) */
        body {
            --bg-primary: #000;
            --bg-secondary: #2a2a2a;
            --bg-card: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            --text-primary: #fff;
            --text-secondary: #888;
            --text-tertiary: #666;
            --border-color: #1a1a1a;
            --accent: #00d46a;
            --status-inactive: #666;
        }

        /* Светлая тема */
        body.light-theme {
            --bg-primary: #f5f5f5;
            --bg-secondary: #e0e0e0;
            --bg-card: linear-gradient(135deg, #fff 0%, #fafafa 100%);
            --text-primary: #000;
            --text-secondary: #666;
            --text-tertiary: #999;
            --border-color: #e0e0e0;
            --accent: #00d46a;
            --status-inactive: #999;
        }

        .app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Логотип */
        .logo {
            text-align: center;
            padding: 20px 0;
            font-size: 24px;
            font-weight: 700;
            font-style: italic;
        }

        /* Контент */
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 0 20px 100px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Статус */
        .status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-secondary);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            margin: 20px 0;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            background: var(--status-inactive);
            border-radius: 50%;
            transition: background 0.3s;
        }

        .status.protected .status-dot {
            background: var(--accent);
        }

        /* Кнопка VPN */
        .vpn-button-container {
            display: flex;
            justify-content: center;
            margin: 40px 0 60px;
        }

        .vpn-button {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .vpn-button:active {
            transform: scale(0.95);
        }

        .vpn-button.active {
            background: var(--accent);
        }

        .power-icon {
            width: 60px;
            height: 60px;
            stroke: var(--text-secondary);
            stroke-width: 3;
            stroke-linecap: round;
            transition: stroke 0.3s;
        }

        .vpn-button.active .power-icon {
            stroke: #fff;
        }

        /* Преимущества */
        .features {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .feature {
            display: flex;
            align-items: flex-start;
            gap: 16px;
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .feature-icon.green {
            background: rgba(0, 212, 106, 0.15);
        }

        .feature-icon.blue {
            background: rgba(0, 163, 255, 0.15);
        }

        .feature-icon.purple {
            background: rgba(138, 99, 210, 0.15);
        }

        .feature-icon svg {
            width: 24px;
            height: 24px;
        }

        .feature-text h3 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .feature-text p {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* Профиль */
        .profile-header {
            text-align: center;
            padding: 30px 0;
        }

        .avatar {
            width: 80px;
            height: 80px;
            background: var(--bg-secondary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
        }

        .avatar svg {
            width: 40px;
            height: 40px;
            fill: #8a63d2;
        }

        .profile-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .profile-email {
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* Карточка подписки */
        .subscription-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .subscription-label {
            font-size: 11px;
            color: var(--accent);
            font-weight: 700;
            margin-bottom: 8px;
            letter-spacing: 1px;
        }

        .subscription-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .subscription-plan {
            font-size: 18px;
            font-weight: 600;
        }

        .subscription-status {
            background: var(--accent);
            color: #000;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .subscription-status.expired {
            background: #ff4444;
            color: #fff;
        }

        .subscription-details {
            display: flex;
            justify-content: space-between;
            gap: 20px;
        }

        .detail-item h4 {
            font-size: 11px;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .detail-item p {
            font-size: 15px;
            font-weight: 600;
        }

        /* Настройки */
        .settings-section {
            margin-bottom: 30px;
        }

        .section-title {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 700;
            margin-bottom: 16px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .menu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .menu-item:active {
            opacity: 0.6;
        }

        .menu-item-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .menu-icon {
            width: 20px;
            height: 20px;
            stroke: var(--text-primary);
            stroke-width: 2;
            transition: stroke 0.3s;
        }

        .menu-text {
            font-size: 15px;
        }

        /* Toggle */
        .toggle {
            position: relative;
            width: 50px;
            height: 28px;
            background: var(--bg-secondary);
            border-radius: 14px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle.active {
            background: var(--accent);
        }

        .toggle-thumb {
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: #fff;
            border-radius: 50%;
            transition: transform 0.3s;
        }

        .toggle.active .toggle-thumb {
            transform: translateX(22px);
        }

        .arrow-icon {
            width: 20px;
            height: 20px;
            stroke: var(--text-tertiary);
            stroke-width: 2;
            transition: stroke 0.3s;
        }

        .version {
            text-align: center;
            padding: 30px 0;
            font-size: 12px;
            color: var(--text-tertiary);
            letter-spacing: 1px;
        }

        /* Навигация */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
            max-width: 600px;
            margin: 0 auto;
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding: 8px;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .nav-item:active {
            opacity: 0.6;
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            stroke: var(--text-tertiary);
            stroke-width: 2;
            transition: stroke 0.3s;
        }

        .nav-item.active .nav-icon {
            stroke: var(--accent);
        }

        .nav-label {
            font-size: 11px;
            color: var(--text-tertiary);
            font-weight: 500;
            letter-spacing: 0.5px;
            transition: color 0.3s;
        }

        .nav-item.active .nav-label {
            color: var(--accent);
        }

        /* Модалка выбора устройства */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: flex-end;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            background: var(--bg-primary);
            border-radius: 20px 20px 0 0;
            padding: 24px;
            animation: slideUp 0.3s;
        }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .modal-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .device-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .device-btn {
            background: var(--bg-secondary);
            border: none;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .device-btn:active {
            transform: scale(0.98);
            opacity: 0.8;
        }

        .device-icon {
            width: 24px;
            height: 24px;
            stroke: var(--text-primary);
            stroke-width: 2;
        }

        .device-name {
            font-size: 16px;
            font-weight: 600;
        }

        .close-modal {
            width: 100%;
            background: transparent;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            color: var(--text-primary);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1001;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        /* Loader */
        .loader {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1002;
        }

        .loader.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--bg-secondary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="logo">VPN</div>

        <div class="content">
            <!-- Вкладка: ЗАЩИТА -->
            <div id="tab-protection" class="tab-content active">
                <div style="text-align: center;">
                    <div class="status" id="status">
                        <div class="status-dot"></div>
                        <span id="statusText">НЕ ЗАЩИЩЕНО</span>
                    </div>
                </div>

                <div class="vpn-button-container">
                    <button class="vpn-button" id="vpnButton">
                        <svg class="power-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M12 2v10M18.36 5.64a9 9 0 1 1-12.73 0" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>

                <div class="features">
                    <div class="feature">
                        <div class="feature-icon green">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#00d46a" stroke-width="2">
                                <rect x="5" y="11" width="14" height="10" rx="2" ry="2"/>
                                <path d="M12 17a1 1 0 1 0 0-2 1 1 0 0 0 0 2z"/>
                                <path d="M8 11V7a4 4 0 0 1 8 0v4"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <h3>Полная конфиденциальность</h3>
                            <p>Шифрование данных высшего уровня</p>
                        </div>
                    </div>

                    <div class="feature">
                        <div class="feature-icon blue">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#00a3ff" stroke-width="2">
                                <path d="M13 2L3 14h8l-1 8 10-12h-8l1-8z"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <h3>Высокая скорость</h3>
                            <p>Без ограничений трафика</p>
                        </div>
                    </div>

                    <div class="feature">
                        <div class="feature-icon purple">
                            <svg viewBox="0 0 24 24" fill="none" stroke="#8a63d2" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                            </svg>
                        </div>
                        <div class="feature-text">
                            <h3>Глобальная сеть</h3>
                            <p>Надежные серверы по всему миру</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Вкладка: ПРОФИЛЬ -->
            <div id="tab-profile" class="tab-content">
                <div class="profile-header">
                    <div class="avatar">
                        <svg viewBox="0 0 24 24">
                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>
                        </svg>
                    </div>
                    <div class="profile-title" id="profileStatus">FREE</div>
                    <div class="profile-email" id="profileEmail">Загрузка...</div>
                </div>

                <div class="subscription-card" id="subscriptionCard">
                    <div class="subscription-label">ПОДПИСКА</div>
                    <div class="subscription-header">
                        <div class="subscription-plan" id="planName">Не активна</div>
                        <div class="subscription-status expired" id="planStatus">НЕАКТИВНА</div>
                    </div>
                    <div class="subscription-details">
                        <div class="detail-item">
                            <h4>ОСТАЛОСЬ</h4>
                            <p id="daysLeft">0 дней</p>
                        </div>
                        <div class="detail-item">
                            <h4>ПРОДЛЕНИЕ</h4>
                            <p id="expiresAt">—</p>
                        </div>
                    </div>
                </div>

                <div class="settings-section">
                    <div class="section-title">НАСТРОЙКИ</div>
                    
                    <div class="menu-item" id="themeMenuItem">
                        <div class="menu-item-left">
                            <svg class="menu-icon" viewBox="0 0 24 24" fill="none">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                            <span class="menu-text" id="themeText">Темная тема</span>
                        </div>
                        <div class="toggle active" id="themeToggle">
                            <div class="toggle-thumb"></div>
                        </div>
                    </div>
                </div>

                <div class="menu-item" id="helpBtn">
                    <div class="menu-item-left">
                        <svg class="menu-icon" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3M12 17h.01"/>
                        </svg>
                        <span class="menu-text">Помощь и поддержка</span>
                    </div>
                    <svg class="arrow-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </div>

                <div class="menu-item" id="referralBtn">
                    <div class="menu-item-left">
                        <svg class="menu-icon" viewBox="0 0 24 24" fill="none">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2M8.5 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM20 8v6M23 11h-6"/>
                        </svg>
                        <span class="menu-text">Реферальная программа</span>
                    </div>
                    <svg class="arrow-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </div>

                <div class="version">WERSIDEPN v2.4.1</div>
            </div>
        </div>

        <!-- Навигация -->
        <div class="bottom-nav">
            <div class="nav-item active" data-tab="protection">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                </svg>
                <span class="nav-label">ЗАЩИТА</span>
            </div>
            <div class="nav-item" data-tab="profile">
                <svg class="nav-icon" viewBox="0 0 24 24" fill="none">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2M12 11a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>
                </svg>
                <span class="nav-label">ПРОФИЛЬ</span>
            </div>
        </div>
    </div>

    <!-- Модалка выбора устройства -->
    <div class="modal" id="deviceModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Выберите устройство</div>
                <div class="modal-subtitle">Установите приложение и подключитесь</div>
            </div>
            <div class="device-buttons">
                <button class="device-btn" data-device="ios">
                    <svg class="device-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                    </svg>
                    <span class="device-name">iPhone / iPad</span>
                </button>
                <button class="device-btn" data-device="android">
                    <svg class="device-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M6 18c0 .55.45 1 1 1h1v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h2v3.5c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5V19h1c.55 0 1-.45 1-1V8H6v10zM3.5 8C2.67 8 2 8.67 2 9.5v7c0 .83.67 1.5 1.5 1.5S5 17.33 5 16.5v-7C5 8.67 4.33 8 3.5 8zm17 0c-.83 0-1.5.67-1.5 1.5v7c0 .83.67 1.5 1.5 1.5s1.5-.67 1.5-1.5v-7c0-.83-.67-1.5-1.5-1.5zm-4.97-5.84l1.3-1.3c.2-.2.2-.51 0-.71-.2-.2-.51-.2-.71 0l-1.48 1.48C13.85 1.23 12.95 1 12 1c-.96 0-1.86.23-2.66.63L7.85.15c-.2-.2-.51-.2-.71 0-.2.2-.2.51 0 .71l1.31 1.31C6.97 3.26 6 5.01 6 7h12c0-1.99-.97-3.75-2.47-4.84zM10 5H9V4h1v1zm5 0h-1V4h1v1z"/>
                    </svg>
                    <span class="device-name">Android</span>
                </button>
                <button class="device-btn" data-device="windows">
                    <svg class="device-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M3 12V6.75l6-1.32v6.48L3 12zm17-9v8.75l-10 .15V5.21L20 3zM3 13l6 .09v6.81l-6-1.15V13zm17 .25V22l-10-1.91V13.1l10 .15z"/>
                    </svg>
                    <span class="device-name">Windows</span>
                </button>
                <button class="device-btn" data-device="macos">
                    <svg class="device-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"/>
                    </svg>
                    <span class="device-name">macOS</span>
                </button>
            </div>
            <button class="close-modal" id="closeModal">Закрыть</button>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Loader -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
    </div>

    <script>
        // Telegram WebApp API
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();

        // Данные пользователя из Telegram
        const user = tg.initDataUnsafe.user;
        const userId = user?.id;
        const username = user?.username || user?.first_name || 'Пользователь';

        // Глобальные переменные
        let userData = null;
        let vpnLink = null;

        // Показать уведомление
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }

        // Показать/скрыть loader
        function showLoader(show) {
            document.getElementById('loader').classList.toggle('show', show);
        }

        // Загрузка данных пользователя
        async function loadUserData() {
            showLoader(true);
            try {
                // Отправляем запрос боту
                tg.sendData(JSON.stringify({
                    action: 'get_user_data',
                    user_id: userId
                }));

                // В реальности данные придут через бота
                // Пока используем моковые данные
                setTimeout(() => {
                    userData = {
                        has_subscription: true,
                        days_left: 247,
                        expires_at: '2026-10-05',
                        plan_name: 'Premium Plan',
                        vpn_link: 'vless://your-vpn-link-here',
                        email: `user${userId}@wersidepn.com`
                    };
                    updateUI();
                    showLoader(false);
                }, 1000);
            } catch (error) {
                console.error('Ошибка загрузки:', error);
                showToast('Ошибка загрузки данных');
                showLoader(false);
            }
        }

        // Обновление UI с данными
        function updateUI() {
            if (!userData) return;

            const profileEmail = document.getElementById('profileEmail');
            const profileStatus = document.getElementById('profileStatus');
            const planName = document.getElementById('planName');
            const planStatus = document.getElementById('planStatus');
            const daysLeft = document.getElementById('daysLeft');
            const expiresAt = document.getElementById('expiresAt');

            profileEmail.textContent = userData.email;

            if (userData.has_subscription) {
                profileStatus.textContent = 'PREMIUM';
                planName.textContent = userData.plan_name;
                planStatus.textContent = 'АКТИВНА';
                planStatus.classList.remove('expired');
                daysLeft.textContent = `${userData.days_left} дней`;
                expiresAt.textContent = new Date(userData.expires_at).toLocaleDateString('ru-RU');
                vpnLink = userData.vpn_link;
            } else {
                profileStatus.textContent = 'FREE';
                planName.textContent = 'Подписка не активна';
                planStatus.textContent = 'НЕАКТИВНА';
                planStatus.classList.add('expired');
                daysLeft.textContent = '0 дней';
                expiresAt.textContent = '—';
            }
        }

        // Переключение вкладок
        const navItems = document.querySelectorAll('.nav-item');
        const tabContents = document.querySelectorAll('.tab-content');

        navItems.forEach(item => {
            item.addEventListener('click', () => {
                const tabName = item.dataset.tab;
                
                navItems.forEach(nav => nav.classList.remove('active'));
                tabContents.forEach(tab => tab.classList.remove('active'));
                
                item.classList.add('active');
                document.getElementById(`tab-${tabName}`).classList.add('active');

                tg.HapticFeedback.impactOccurred('light');
            });
        });

        // VPN кнопка - открывает выбор устройства
        const vpnButton = document.getElementById('vpnButton');
        const deviceModal = document.getElementById('deviceModal');

        vpnButton.addEventListener('click', () => {
            if (!userData || !userData.has_subscription) {
                showToast('Необходима активная подписка');
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            if (!vpnLink) {
                showToast('Ошибка получения ключа');
                tg.HapticFeedback.notificationOccurred('error');
                return;
            }

            deviceModal.classList.add('show');
            tg.HapticFeedback.impactOccurred('medium');
        });

        // Закрытие модалки
        document.getElementById('closeModal').addEventListener('click', () => {
            deviceModal.classList.remove('show');
            tg.HapticFeedback.impactOccurred('light');
        });

        // Клик вне модалки
        deviceModal.addEventListener('click', (e) => {
            if (e.target === deviceModal) {
                deviceModal.classList.remove('show');
            }
        });

        // Выбор устройства
        const deviceButtons = document.querySelectorAll('.device-btn');
        deviceButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                const device = btn.dataset.device;
                tg.HapticFeedback.impactOccurred('medium');
                
                // Отправляем данные боту для открытия инструкции
                tg.sendData(JSON.stringify({
                    action: 'open_instruction',
                    device: device,
                    vpn_link: vpnLink
                }));

                showToast(`Открываю инструкцию для ${device}`);
                deviceModal.classList.remove('show');
            });
        });

        // Переключение темы
        const themeToggle = document.getElementById('themeToggle');
        const themeMenuItem = document.getElementById('themeMenuItem');
        const themeText = document.getElementById('themeText');
        let isDarkTheme = true;

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'light') {
            isDarkTheme = false;
            document.body.classList.add('light-theme');
            themeToggle.classList.remove('active');
            themeText.textContent = 'Светлая тема';
        }

        if (tg.colorScheme === 'light' && isDarkTheme) {
            isDarkTheme = false;
            document.body.classList.add('light-theme');
            themeToggle.classList.remove('active');
            themeText.textContent = 'Светлая тема';
        }

        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            
            if (isDarkTheme) {
                document.body.classList.remove('light-theme');
                themeToggle.classList.add('active');
                themeText.textContent = 'Темная тема';
                localStorage.setItem('theme', 'dark');
                showToast('Темная тема включена');
            } else {
                document.body.classList.add('light-theme');
                themeToggle.classList.remove('active');
                themeText.textContent = 'Светлая тема';
                localStorage.setItem('theme', 'light');
                showToast('Светлая тема включена');
            }

            tg.HapticFeedback.impactOccurred('medium');
        }

        themeToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleTheme();
        });

        themeMenuItem.addEventListener('click', toggleTheme);

        // Помощь и поддержка
        document.getElementById('helpBtn').addEventListener('click', () => {
            tg.HapticFeedback.impactOccurred('light');
            tg.openTelegramLink('https://t.me/wersidepn_bot');
        });

        // Реферальная программа
        document.getElementById('referralBtn').addEventListener('click', () => {
            tg.HapticFeedback.impactOccurred('light');
            tg.sendData(JSON.stringify({
                action: 'show_referral'
            }));
            showToast('Открываю реферальную программу');
        });

        // Синхронизация темы с Telegram
        tg.onEvent('themeChanged', () => {
            if (tg.colorScheme === 'dark' && !isDarkTheme) {
                toggleTheme();
            } else if (tg.colorScheme === 'light' && isDarkTheme) {
                toggleTheme();
            }
        });

        // Инициализация
        if (userId) {
            loadUserData();
        } else {
            showToast('Ошибка: откройте через Telegram');
        }
    </script>
</body>
</html>
